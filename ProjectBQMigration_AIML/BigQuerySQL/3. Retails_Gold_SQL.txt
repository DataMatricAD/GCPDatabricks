--Create gold tables with schema

CREATE SCHEMA IF NOT EXISTS `gcp-dbsbq-migration.retail_gold`;

--Revenue and Sales Summary (Per Day + Store)

CREATE OR REPLACE TABLE gcp-dbsbq-migration.retail_gold.gold_daily_store_sales AS
SELECT 
  DATE(o.order_date) AS order_date,
  o.store_id,
  o.store_name,
  COUNT(DISTINCT o.order_id) AS total_orders,
  SUM(oi.total_price) AS revenue
FROM gcp-dbsbq-migration.retail_silver.orders o
JOIN gcp-dbsbq-migration.retail_silver.order_items oi USING (order_id)
WHERE o.status = 'completed'
GROUP BY 1, 2, 3;

--Top Selling Products

CREATE OR REPLACE TABLE gcp-dbsbq-migration.retail_gold.gold_top_products AS
SELECT 
  product_id,
  product_name,
  category,
  SUM(quantity) AS total_quantity_sold,
  SUM(total_price) AS total_revenue
FROM gcp-dbsbq-migration.retail_silver.order_items
GROUP BY 1, 2, 3
ORDER BY total_revenue DESC
LIMIT 20;

--Inventory Health Report

CREATE OR REPLACE TABLE gcp-dbsbq-migration.retail_gold.gold_inventory_health AS
SELECT 
  store_id,
  store_name,
  product_id,
  product_name,
  stock,
  CASE 
    WHEN stock = 0 THEN 'Out of Stock'
    WHEN stock < 10 THEN 'Low Stock'
    ELSE 'In Stock'
  END AS stock_status
FROM gcp-dbsbq-migration.retail_silver.inventory;

--customer feature
CREATE OR REPLACE TABLE gcp-dbsbq-migration.retail_gold.gold_customer_features AS
SELECT 
  o.customer_id,
  ANY_VALUE(c.first_name) AS first_name,
  ANY_VALUE(c.last_name) AS last_name,
  COUNT(DISTINCT o.order_id) AS total_orders,
  COUNT(DISTINCT o.store_id) AS unique_stores_visited,
  SUM(oi.total_price) AS lifetime_value,
  AVG(oi.total_price) AS avg_order_value,
  MIN(o.order_date) AS first_order_date,
  MAX(o.order_date) AS last_order_date,
  --DATE_DIFF(CURRENT_DATE(), MAX(o.order_date), DAY) AS days_since_last_order,
  DATE_DIFF(CURRENT_DATE(), DATE(MAX(o.order_date)), DAY) AS days_since_last_order,
  APPROX_QUANTILES(oi.total_price, 5)[OFFSET(3)] AS median_order_value
FROM gcp-dbsbq-migration.retail_silver.orders o
JOIN gcp-dbsbq-migration.retail_silver.order_items oi USING (order_id)
LEFT JOIN gcp-dbsbq-migration.retails_db.customer_tbl c USING (customer_id)
WHERE o.status = 'completed'
GROUP BY o.customer_id;


